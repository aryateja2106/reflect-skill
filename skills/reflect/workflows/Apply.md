# Apply Workflow

Safely applies approved learnings to target files.

## Trigger
- After Review workflow approval
- Never runs without explicit user confirmation

## Input
- Approved learnings with scope and target from Review workflow

## Process

### Step 1: Pre-flight Checks

```bash
# For each target file:

# 1. Check if file exists or can be created
if [[ ! -f "$TARGET" ]]; then
  echo "Creating new file: $TARGET"
fi

# 2. Check write permissions
if [[ -f "$TARGET" && ! -w "$TARGET" ]]; then
  echo "ERROR: $TARGET is not writable"
  exit 1
fi

# 3. Create backup
cp "$TARGET" "${TARGET}.bak.$(date +%s)" 2>/dev/null || true
```

### Step 2: Generate Content

Use simple template substitution:

```bash
ISO_DATE=$(date +%Y-%m-%d)

# For new Learnings section:
CONTENT="
## Learnings
<!-- Generated by /reflect | $ISO_DATE -->

### Constraints
$CONSTRAINTS

### Patterns  
$PATTERNS
"

# For appending to existing section:
CONTENT="
- $LEARNING_TEXT
"
```

### Step 3: Safe Append

Run `tools/SafeAppend.sh`:

```bash
./tools/SafeAppend.sh \
  --file "$TARGET" \
  --section "## Learnings" \
  --content "$CONTENT"
```

**Critical**: This tool APPENDS to sections, never edits existing lines.

### Step 4: Git Commit (Optional)

If in a git repository:

```bash
./tools/GitSafeCommit.sh \
  --files "$TARGET" \
  --message "reflect: add $CATEGORY - $SUMMARY | $ISO_DATE"
```

### Step 5: Output Summary

```
REFLECTION COMPLETE

Applied 2 learnings:
- CONSTRAINT: Never use inline CSS
- PATTERN: Use bun instead of npm

Modified: ./CLAUDE.md
Backup: ./CLAUDE.md.bak.1704412800

Git commit: abc1234
Message: reflect: add constraints and patterns | 2026-01-05
```

### Rollback

If anything fails after partial changes:

```bash
# Restore from backup
if [[ -f "${TARGET}.bak."* ]]; then
  BACKUP=$(ls -t "${TARGET}.bak."* | head -1)
  mv "$BACKUP" "$TARGET"
  echo "Rolled back to: $BACKUP"
fi
```

## Error Handling

| Error | Action |
|-------|--------|
| File not writable | Show error, suggest chmod |
| Git commit fails | Skip git, keep file changes |
| Partial failure | Rollback all changes |
